{% extends "base.html" %}
{%block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/schedule.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/home.css') }}">
    <script src="{{ url_for('static', filename='js/schedule.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="{{ url_for('static', filename='js/production.js') }}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
{% endblock %}
{% block title %}Programme{% endblock %}

{% block content %}
<div class="container">
    <!-- Week Navigation -->
    <div class="week-navigation">
        <div class="week-selector-container">
            <div class="calendar-preview">
                <div class="navigation-row">
                    <span class="week-label">Semaine</span>
                    <button type="button" class="nav-btn" onclick="changeWeek(-1)" title="Semaine précédente">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="week-info">
                        <input type="number" id="weekInput" class="current-value" value="{{ week }}" min="1" max="53" onchange="updateWeekFromInput(this.value)">
                    </div>
                    <button type="button" class="nav-btn" onclick="changeWeek(1)" title="Semaine suivante">
                        <i class="fas fa-chevron-right"></i>
                    </button>

                    <div class="separator"></div>

                    <div class="week-dates" id="weekDatesDisplay"></div>
                    
                    <div class="separator"></div>

                    <span class="year-label">Année</span>
                    <button type="button" class="nav-btn" onclick="changeYear(-1)" title="Année précédente">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="year-display">
                        <input type="number" id="yearInput" class="current-value" value="{{ year }}" min="1900" max="2100" onchange="updateYearFromInput(this.value)">
                    </div>
                    <button type="button" class="nav-btn" onclick="changeYear(1)" title="Année suivante">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                
            </div>
        </div>
    </div>

    <!-- Schedule Grid -->
    <div class="assignments-table">
        <table>
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all-machines" onclick="toggleAllMachines(this)"></th>
                    <th>Machine</th>
                    <th>7h->15h</th>
                    <th>15h->23h</th>
                    <th>23h->7h</th>
                    <th>7h->19h</th>
                    <th>19h->7h</th>
                    <th>9h->17h</th>
                </tr>
            </thead>
            <tbody>
                {% for machine in machines %}
                <tr>
                    <td><input type="checkbox" class="machine-checkbox" data-machine-id="{{ machine.id }}" data-production-id="{{ machine.production_id }}"></td>
                    <td {% if machine.production_id %}onclick="editProduction('{{ machine.production_id }}')" style="cursor:pointer;" onmouseover="this.style.color='#1461d4'" onmouseout="this.style.color='black'" {% endif %}>
                        {{ machine.name }}
                        {% if machine.article_name %}
                        <br><small class="text-muted">{{ machine.article_name }}</small>
                        {% endif %}
                    </td>
                    {% for shift_id in range(1, 7) %}
                    <td class="schedule-cell" 
                        data-machine-id="{{ machine.id }}"
                        data-production-id="{{ machine.production_id }}"
                        data-shift-id="{{ shift_id }}"
                        draggable="true"
                        ondragstart="handleDragStart(event)"
                        ondragover="handleDragOver(event)"
                        ondrop="handleDrop(event)"
                        ondragend="handleDragEnd(event)">
                        <div class="operators-container">
                            <button class="add-operator-btn" onclick="addOperator(this)"><i class='bx bx-plus'></i></button>
                            <div class="operators-list">
                                {% set found = false %}
                                {% for assignment in assignments if assignment.machine_id == machine.id and assignment.production_id == machine.production_id and assignment.shift_id == shift_id %}
                                <div class="operator-item">
                                    <div class="select-wrapper">
                                        <select class="operator-select" 
                                                data-machine-id="{{ machine.id }}"
                                                data-production-id="{{ machine.production_id }}"
                                                data-shift-id="{{ shift_id }}"
                                                data-position="{{ assignment.position }}"
                                                onchange="handleOperatorSelection(this)">
                                            <option value="">Sélectionner un opérateur</option>
                                            {% for operator in operators %}
                                            <option value="{{ operator.id }}" 
                                                    {% if assignment.operator_id == operator.id %}selected{% endif %}
                                                    {% if operator.absence_status == 'current_absence' or operator.absence_status == 'long_absence' %}disabled style="color: #b3b3b3;"{% endif %}
                                                    data-last-shift="{{ operator.last_shift_id }}"
                                                    data-next-shift="{% if operator.last_shift_id == 1 %}3{% elif operator.last_shift_id == 3 %}2{% elif operator.last_shift_id == 2 %}1{% else %}1{% endif %}">
                                                {{ operator.name }}
                                                {% if (operator.absence_status == 'upcoming_absence' or operator.absence_status == 'long_absence' or operator.absence_status == 'current_absence') and operator.start_date %}
                                                    ({{ operator.start_date }}{% if operator.end_date and operator.end_date != operator.start_date %} -> {{ operator.end_date }}{% endif %})
                                                {% endif %}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        <span class="deselect-operator" onclick="deselectOperator(event, this)"><i class='bx bx-x'></i></span>
                                    </div>
                                </div>
                                {% set found = true %}
                                {% endfor %}
                                {% if not found %}
                                <div class="operator-item">
                                    <div class="select-wrapper">
                                        <select class="operator-select" 
                                                data-machine-id="{{ machine.id }}"
                                                data-production-id="{{ machine.production_id }}"
                                                data-shift-id="{{ shift_id }}"
                                                data-position="1"
                                                onchange="handleOperatorSelection(this)">
                                            <option value="">Sélectionner un opérateur</option>
                                            {% for operator in operators %}
                                            <option value="{{ operator.id }}" 
                                                    {% if operator.absence_status == 'current_absence' or operator.absence_status == 'long_absence' %}disabled style="color: #b3b3b3;"{% endif %}
                                                    data-last-shift="{{ operator.last_shift_id }}"
                                                    data-next-shift="{% if operator.last_shift_id == 1 %}3{% elif operator.last_shift_id == 3 %}2{% elif operator.last_shift_id == 2 %}1{% else %}1{% endif %}">
                                                {{ operator.name }}
                                                {% if (operator.absence_status == 'upcoming_absence' or operator.absence_status == 'long_absence' or operator.absence_status == 'current_absence') and operator.start_date %}
                                                    ({{ operator.start_date }}{% if operator.end_date and operator.end_date != operator.start_date %} -> {{ operator.end_date }}{% endif %})
                                                {% endif %}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        <span class="deselect-operator" onclick="deselectOperator(event, this)"><i class='bx bx-x'></i></span>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="actions-container" style="margin-top: 20px;">
            <div class="button-group">
                {% if can_edit %}
                <div class="button-pair">
                    <button type="button" class="add-production-btn" data-bs-toggle="modal" data-bs-target="#addProductionModal">
                        <i class='bx bx-plus'></i>
                    </button>
                    <button id="random-assignment-button" onclick="randomAssignment()">Affectations aléatoires</button>
                </div>
                <div class="export-buttons">
                    <button id="export-latin-pdf-button" onclick="exportToPDF('latin')" class="export-btn">Exporter en Français</button>
                    <button id="export-arabic-pdf-button" onclick="exportToPDF('arabic')" class="export-btn">Exporter en Arabe</button>
                </div>
                <div class="button-pair">
                    <button id="remove-display-button" onclick="removeFromDisplay()">Réinitialiser</button>
                    <button id="confirm-button" onclick="confirmAssignments()">Confirmer</button>
                </div>
                {% else %}    
                <div class="export-buttons">
                    <button id="export-latin-pdf-button" onclick="exportToPDF('latin')" class="export-btn">Exporter en Français</button>
                    <button id="export-arabic-pdf-button" onclick="exportToPDF('arabic')" class="export-btn">Exporter en Arabe</button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if can_edit %}
<!-- Add Production Modal -->
<div class="modal fade" id="addProductionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajouter une production</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addProductionForm" data-form-action="saveProduction">
                    <div class="mb-3">
                        <label for="productionMachine" class="form-label">Machine</label>
                        <select class="form-select" id="productionMachine" required onchange="toggleArticleFields()">
                            <option value="">Sélectionner une machine</option>
                            {% for machine in all_machines %}
                            <option value="{{ machine.id }}" data-type="{{ machine.type }}">{{ machine.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3 article-field">
                        <label for="productionArticle" class="form-label">Article</label>
                        <select class="form-select" id="productionArticle">
                            <option value="">Sélectionner un article</option>
                            {% for article in articles %}
                            <option value="{{ article.id }}">{{ article.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3 article-field">
                        <label for="productionQuantity" class="form-label">Quantité</label>
                        <input type="number" class="form-control" id="productionQuantity">
                    </div>
                    <div class="mb-3">
                        <label for="productionStartDate" class="form-label">Date de début</label>
                        <input type="date" class="form-control" id="productionStartDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="productionEndDate" class="form-label">Date de fin</label>
                        <input type="date" class="form-control" id="productionEndDate">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-primary" data-action="save-production">Enregistrer</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Production Modal -->
<div class="modal fade" id="editProductionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modifier la production</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editProductionForm" data-form-action="splitProduction">
                    <input type="hidden" id="editProductionId">
                    <div class="mb-3">
                        <label for="editProductionMachine" class="form-label">Machine</label>
                        <select class="form-select" id="editProductionMachine" required>
                            <option value="">Sélectionner une machine</option>
                            {% for machine in all_machines %}
                            <option value="{{ machine.id }}" data-type="{{ machine.type }}">{{ machine.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3 article-field">
                        <label for="editProductionArticle" class="form-label">Article</label>
                        <select class="form-select" id="editProductionArticle">
                            <option value="">Sélectionner un article</option>
                            {% for article in articles %}
                            <option value="{{ article.id }}">{{ article.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3 article-field">
                        <label for="editProductionQuantity" class="form-label">Quantité</label>
                        <input type="number" class="form-control" id="editProductionQuantity">
                    </div>
                    <div class="mb-3">
                        <label for="editProductionStartDate" class="form-label">Date de début</label>
                        <input type="date" class="form-control" id="editProductionStartDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="editProductionEndDate" class="form-label">Date de fin</label>
                        <input type="date" class="form-control" id="editProductionEndDate">
                    </div>
                    <div class="mb-3">
                        <label for="editProductionStatus" class="form-label">Statut</label>
                        <select class="form-select" id="editProductionStatus" required>
                            <option value="active">Actif</option>
                            <option value="completed">Terminé</option>
                            <option value="cancelled">Annulé</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-primary" onclick="saveSplitProduction()">Enregistrer</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
function exportToPDF(nameType) {
    // Get current week and year from the page
    const week = {{ week }};
    const year = {{ year }};
    
    // Create a loading state
    const button = document.getElementById(`export-${nameType}-pdf-button`);
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = nameType === 'latin' ? 'Génération du PDF...' : 'جاري التصدير...';
    
    // Open the export URL in a new tab with the name type parameter
    window.open(`/export_schedule?week=${week}&year=${year}&name_type=${nameType}`, '_blank');
    
    // Restore button state after a short delay
    setTimeout(() => {
        button.disabled = false;
        button.textContent = originalText;
    }, 1000);
}

const selectedOperators = new Set();

function handleOperatorSelection(selectElement) {
    const wrapper = selectElement.parentElement;

    // Remove previously selected operator from the set
    const previousOperator = selectElement.dataset.selectedOperator;
    if (previousOperator) {
        selectedOperators.delete(previousOperator);
    }

    // Add the new operator to the set
    if (selectElement.value) {
        if (selectedOperators.has(selectElement.value)) {
            alert('Cet opérateur est déjà affecté à un autre poste.');
            selectElement.value = ""; // Reset the selection
            return;
        }
        selectedOperators.add(selectElement.value);
    }

    // Update the dataset to track the selected operator
    selectElement.dataset.selectedOperator = selectElement.value;

    // Update positions for all operators in the same cell
    const operatorsList = selectElement.closest('.operators-list');
    Array.from(operatorsList.children).forEach((item, index) => {
        const itemSelect = item.querySelector('.operator-select');
        if (itemSelect) {
            itemSelect.dataset.position = index + 1;
        }
    });

    // Disable the selected operator in other dropdowns
    updateOperatorDropdowns();
}

function updateOperatorDropdowns() {
    const allDropdowns = document.querySelectorAll('.operator-select');
    allDropdowns.forEach(dropdown => {
        const currentOperator = dropdown.dataset.selectedOperator;
        const currentShiftId = parseInt(dropdown.dataset.shiftId);
        const options = Array.from(dropdown.querySelectorAll('option'));
        
        // Clear the dropdown
        dropdown.innerHTML = '';
        
        // Add the default option
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Sélectionner un opérateur';
        dropdown.appendChild(defaultOption);
        
        // Add enabled options first
        options.forEach(option => {
            if (option.value && !selectedOperators.has(option.value) && !option.disabled) {
                // Check if operator is in long absence
                if (option.style.display === 'none') {
                    return; // Skip operators in long absence
                }
                
                // Check if this is the operator's next expected shift
                const lastShift = parseInt(option.dataset.lastShift);
                const nextShift = parseInt(option.dataset.nextShift);
                const isNextExpectedShift = nextShift === currentShiftId;
                
                option.disabled = false;
                option.style.color = isNextExpectedShift ? '#4CAF50' : 'black';
                option.style.fontWeight = isNextExpectedShift ? 'bold' : 'normal';
                dropdown.appendChild(option);
            }
        });
        
        // Add disabled options at the bottom
        options.forEach(option => {
            if (option.value && (selectedOperators.has(option.value) || option.disabled)) {
                // Check if operator is in long absence
                if (option.style.display === 'none') {
                    return; // Skip operators in long absence
                }
                option.disabled = true;
                option.style.color = '#b3b3b3';
                dropdown.appendChild(option);
            }
        });
        
        // Restore the current selection
        if (currentOperator) {
            dropdown.value = currentOperator;
        }
    });
}

function confirmAssignments() {
    const assignments = [];
    const allOperatorSelects = document.querySelectorAll('.operator-select');
    
    allOperatorSelects.forEach(select => {
        if (select.value) {
            assignments.push({
                machine_id: select.dataset.machineId,
                production_id: select.dataset.productionId,
                shift_id: select.dataset.shiftId,
                operator_id: select.value,
                position: select.dataset.position
            });
        }
    });

    if (assignments.length === 0) {
        alert('Aucune affectation sélectionnée.');
        return;
    }

    fetch('/api/schedule/confirm', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            assignments: assignments,
            week_number: {{ week }},
            year: {{ year }}
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const weekKey = `week_{{ week }}_year_{{ year }}`;
            sessionStorage.setItem(weekKey, JSON.stringify(assignments));
            sessionStorage.setItem(`${weekKey}_confirmed`, 'true');
            
            const successMessage = document.createElement('div');
            successMessage.className = 'alert-success';
            successMessage.textContent = 'Affectations confirmées avec succès.';
            document.querySelector('.actions-container').insertBefore(successMessage, document.querySelector('.button-group'));
            
            setTimeout(() => {
                successMessage.remove();
            }, 3000);
        } else {
            const errorMessage = document.createElement('div');
            errorMessage.className = 'alert-error';
            errorMessage.textContent = 'Erreur : ' + data.message;
            document.querySelector('.actions-container').insertBefore(errorMessage, document.querySelector('.button-group'));
            
            setTimeout(() => {
                errorMessage.remove();
            }, 5000);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        const errorMessage = document.createElement('div');
        errorMessage.className = 'alert-error';
        errorMessage.textContent = 'Erreur lors de la confirmation des affectations.';
        document.querySelector('.actions-container').insertBefore(errorMessage, document.querySelector('.button-group'));
        
        setTimeout(() => {
            errorMessage.remove();
        }, 5000);
    });
}

function loadStoredAssignments() {
    const weekKey = `week_{{ week }}_year_{{ year }}`;
    const storedAssignments = sessionStorage.getItem(weekKey);
    const isConfirmed = sessionStorage.getItem(`${weekKey}_confirmed`);
    
    if (storedAssignments && isConfirmed) {
        const assignments = JSON.parse(storedAssignments);
        
        // Group assignments by machine, production, and shift
        const groupedAssignments = {};
        assignments.forEach(assignment => {
            const key = `${assignment.machine_id}-${assignment.production_id}-${assignment.shift_id}`;
            if (!groupedAssignments[key]) {
                groupedAssignments[key] = [];
            }
            groupedAssignments[key].push(assignment);
        });
        
        // For each group of assignments
        Object.values(groupedAssignments).forEach(groupAssignments => {
            const firstAssignment = groupAssignments[0];
            const cell = document.querySelector(`.schedule-cell[data-machine-id="${firstAssignment.machine_id}"][data-production-id="${firstAssignment.production_id}"][data-shift-id="${firstAssignment.shift_id}"]`);
            
            if (cell) {
                const operatorsList = cell.querySelector('.operators-list');
                // Clear existing operator items except the last empty one
                while (operatorsList.children.length > 1) {
                    operatorsList.removeChild(operatorsList.firstChild);
                }
                
                // Add operator items for each assignment
                groupAssignments.forEach((assignment, index) => {
                    if (index === 0) {
                        // Use the existing first select
                        const firstSelect = operatorsList.querySelector('.operator-select');
                        firstSelect.value = assignment.operator_id;
                        firstSelect.dataset.selectedOperator = assignment.operator_id;
                        firstSelect.dataset.position = assignment.position;
                    } else {
                        // Add new operator items for additional operators
                        const operatorItem = document.createElement('div');
                        operatorItem.className = 'operator-item';
                        const select = operatorsList.querySelector('.operator-select').cloneNode(true);
                        select.value = assignment.operator_id;
                        select.dataset.selectedOperator = assignment.operator_id;
                        select.dataset.position = assignment.position;
                        operatorItem.appendChild(select);
                        const deselectBtn = document.createElement('span');
                        deselectBtn.className = 'deselect-operator';
                        deselectBtn.textContent = '×';
                        deselectBtn.onclick = (event) => deselectOperator(event, deselectBtn);
                        operatorItem.appendChild(deselectBtn);
                        operatorsList.insertBefore(operatorItem, operatorsList.lastElementChild);
                    }
                    selectedOperators.add(assignment.operator_id);
                });
            }
        });
        
        // Update all dropdowns
        updateOperatorDropdowns();
        
        // Show confirmation message
        const successMessage = document.createElement('div');
        successMessage.className = 'alert-success';
        successMessage.textContent = 'Affectations confirmées avec succès.';
        document.querySelector('.actions-container').insertBefore(successMessage, document.querySelector('.button-group'));
    }
}

// Initialize select containers and clear icons
function initializeSelects() {
    const allDropdowns = document.querySelectorAll('.operator-select');
    
    allDropdowns.forEach(dropdown => {
        // Create container
        const container = document.createElement('div');
        container.className = 'select-wrapper';
        
        // Wrap the select
        dropdown.parentNode.insertBefore(container, dropdown);
        container.appendChild(dropdown);
        
        // Add click handler for the wrapper
        container.addEventListener('click', function(e) {
            if (e.target === container && dropdown.value) {
                e.stopPropagation();
                selectedOperators.delete(dropdown.value);
                dropdown.value = '';
                delete dropdown.dataset.selectedOperator;
                updateOperatorDropdowns();
            }
        });
        
        // Initialize if has value
        if (dropdown.value) {
            selectedOperators.add(dropdown.value);
            dropdown.dataset.selectedOperator = dropdown.value;
        }
    });
}

// Update DOMContentLoaded event listener
document.addEventListener('DOMContentLoaded', function() {
    updateWeekDatesDisplay();
    loadStoredAssignments();
    initializeSelects();
    updateOperatorDropdowns();
});

function removeFromDisplay() {
    // Get checked machines
    const checkedMachines = Array.from(document.querySelectorAll('.machine-checkbox:checked'))
        .map(checkbox => ({
            machineId: checkbox.dataset.machineId,
            productionId: checkbox.dataset.productionId
        }));
    
    // Clear session storage for current week
    const weekKey = `week_{{ week }}_year_{{ year }}`;
    sessionStorage.removeItem(weekKey);
    sessionStorage.removeItem(`${weekKey}_confirmed`);
    
    // Clear all dropdowns for checked machines
    const allDropdowns = document.querySelectorAll('.operator-select');
    allDropdowns.forEach(dropdown => {
        if (checkedMachines.length === 0 || 
            checkedMachines.some(m => m.machineId === dropdown.dataset.machineId && 
                                    m.productionId === dropdown.dataset.productionId)) {
            dropdown.value = '';
            const previousOperator = dropdown.dataset.selectedOperator;
            if (previousOperator) {
                selectedOperators.delete(previousOperator);
                delete dropdown.dataset.selectedOperator;
            }
        }
    });
    
    // Update dropdowns
    updateOperatorDropdowns();
    
    // Show success message
    const successMessage = document.createElement('div');
    successMessage.className = 'alert-success';
    successMessage.textContent = checkedMachines.length > 0 
        ? 'Affectations effacées pour les machines sélectionnées.' 
        : 'Toutes les affectations ont été réinitialisées.';
    document.querySelector('.actions-container').insertBefore(successMessage, document.querySelector('.button-group'));
    
    // Remove success message after 3 seconds
    setTimeout(() => {
        successMessage.remove();
    }, 3000);
}

function randomAssignment() {
    const button = document.getElementById('random-assignment-button');
    const originalText = button.textContent;
    
    // Show loading state
    button.disabled = true;
    button.textContent = 'Génération des affectations aléatoires...';
    
    try {
        // Get checked machines with their production IDs
        const checkedMachines = Array.from(document.querySelectorAll('.machine-checkbox:checked'))
            .map(checkbox => ({
                machineId: checkbox.dataset.machineId,
                productionId: checkbox.dataset.productionId
            }));
        
        if (checkedMachines.length === 0) {
            throw new Error('Veuillez sélectionner au moins une machine');
        }
        
        // Make API call to backend
        fetch('/api/schedule/random', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                week_number: {{ week }},
                year: {{ year }},
                machine_ids: checkedMachines.map(m => m.machineId)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Group assignments by machine and shift
                const groupedAssignments = {};
                data.assignments.forEach(assignment => {
                    const key = `${assignment.machine_id}-${assignment.production_id}-${assignment.shift_id}`;
                    if (!groupedAssignments[key]) {
                        groupedAssignments[key] = [];
                    }
                    groupedAssignments[key].push(assignment);
                });

                // Clear existing selections ONLY for checked machines
                const allCells = document.querySelectorAll('.schedule-cell');
                allCells.forEach(cell => {
                    const isChecked = checkedMachines.some(m => 
                        m.machineId === cell.dataset.machineId && 
                        m.productionId === cell.dataset.productionId
                    );
                    
                    if (isChecked) {
                        const operatorsList = cell.querySelector('.operators-list');
                        // Clear all operator items except the last empty one
                        while (operatorsList.children.length > 1) {
                            const select = operatorsList.children[0].querySelector('.operator-select');
                            if (select && select.dataset.selectedOperator) {
                                selectedOperators.delete(select.dataset.selectedOperator);
                            }
                            operatorsList.removeChild(operatorsList.children[0]);
                        }
                        // Clear the last empty one
                        const lastSelect = operatorsList.querySelector('.operator-select');
                        if (lastSelect) {
                            lastSelect.value = '';
                            delete lastSelect.dataset.selectedOperator;
                        }
                    }
                });

                // Apply new assignments ONLY for checked machines
                Object.values(groupedAssignments).forEach(assignments => {
                    if (assignments.length > 0) {
                        const firstAssignment = assignments[0];
                        const isChecked = checkedMachines.some(m => 
                            m.machineId === firstAssignment.machine_id.toString() && 
                            m.productionId === firstAssignment.production_id.toString()
                        );
                        
                        if (!isChecked) {
                            return; // Skip unchecked machines
                        }
                        
                        const cell = document.querySelector(`.schedule-cell[data-machine-id="${firstAssignment.machine_id}"][data-production-id="${firstAssignment.production_id}"][data-shift-id="${firstAssignment.shift_id}"]`);
                        
                        if (cell) {
                            const operatorsList = cell.querySelector('.operators-list');
                            
                            assignments.forEach((assignment, index) => {
                                if (assignment.operator_id === null) return;
                                
                                if (index === 0) {
                                    // Use existing first select
                                    const firstSelect = operatorsList.querySelector('.operator-select');
                                    firstSelect.value = assignment.operator_id;
                                    firstSelect.dataset.selectedOperator = assignment.operator_id;
                                    firstSelect.dataset.position = index + 1;
                                    selectedOperators.add(assignment.operator_id);
                        } else {
                                    // Add new operator item
                                    const operatorItem = document.createElement('div');
                                    operatorItem.className = 'operator-item';
                                    const select = operatorsList.querySelector('.operator-select').cloneNode(true);
                                    select.value = assignment.operator_id;
                                    select.dataset.selectedOperator = assignment.operator_id;
                                    select.dataset.position = index + 1;
                                    operatorItem.appendChild(select);
                                    
                                    const deselectBtn = document.createElement('span');
                                    deselectBtn.className = 'deselect-operator';
                                    deselectBtn.textContent = '×';
                                    deselectBtn.onclick = (event) => deselectOperator(event, deselectBtn);
                                    operatorItem.appendChild(deselectBtn);
                                    
                                    operatorsList.insertBefore(operatorItem, operatorsList.lastElementChild);
                                    selectedOperators.add(assignment.operator_id);
                                }
                            });
                        }
                    }
                });
                
                // Update the UI
                updateOperatorDropdowns();
                
                // Show success message
                const successMessage = document.createElement('div');
                successMessage.className = 'alert-success';
                successMessage.textContent = data.message || 'Affectations aléatoires générées avec succès';
                document.querySelector('.actions-container').insertBefore(successMessage, document.querySelector('.button-group'));
                
                // Remove success message after 3 seconds
                setTimeout(() => {
                    successMessage.remove();
                }, 3000);
            } else {
                throw new Error(data.message || 'Erreur lors de la génération des affectations aléatoires');
            }
        })
        .catch(error => {
            // Show error message
            const errorMessage = document.createElement('div');
            errorMessage.className = 'alert-error';
            errorMessage.textContent = error.message || 'Erreur lors de la génération des affectations aléatoires';
            document.querySelector('.actions-container').insertBefore(errorMessage, document.querySelector('.button-group'));
            
            // Remove error message after 5 seconds
            setTimeout(() => {
                errorMessage.remove();
            }, 5000);
        });
        
    } catch (error) {
        // Show error message
        const errorMessage = document.createElement('div');
        errorMessage.className = 'alert-error';
        errorMessage.textContent = error.message || 'Erreur lors de la génération des affectations aléatoires';
        document.querySelector('.actions-container').insertBefore(errorMessage, document.querySelector('.button-group'));
        
        // Remove error message after 5 seconds
        setTimeout(() => {
            errorMessage.remove();
        }, 5000);
    } finally {
        // Restore button state
        button.disabled = false;
        button.textContent = originalText;
    }
}

function toggleAllMachines(checkbox) {
    const machineCheckboxes = document.querySelectorAll('.machine-checkbox');
    machineCheckboxes.forEach(box => {
        box.checked = checkbox.checked;
    });
}

// Add these new functions for drag and drop functionality
let draggedCell = null;

function handleDragStart(event) {
    draggedCell = event.target;
    event.target.classList.add('dragging');
    event.dataTransfer.effectAllowed = 'move';
    event.dataTransfer.setData('text/plain', JSON.stringify({
        machineId: event.target.dataset.machineId,
        productionId: event.target.dataset.productionId,
        shiftId: event.target.dataset.shiftId
    }));
}

function handleDragOver(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'move';
    event.target.classList.add('drag-over');
}

function handleDragEnd(event) {
    event.target.classList.remove('dragging');
    document.querySelectorAll('.schedule-cell').forEach(cell => {
        cell.classList.remove('drag-over');
    });
}

function handleDrop(event) {
    event.preventDefault();
    const targetCell = event.target.closest('.schedule-cell');
    if (!targetCell || !draggedCell) return;

    targetCell.classList.remove('drag-over');

    // Get the select elements
    const sourceSelect = draggedCell.querySelector('select');
    const targetSelect = targetCell.querySelector('select');

    // Store the current values and selected operators
    const sourceValue = sourceSelect.value;
    const targetValue = targetSelect.value;
    const sourceOperator = sourceSelect.dataset.selectedOperator;
    const targetOperator = targetSelect.dataset.selectedOperator;

    // Remove both operators from the selected set
    if (sourceOperator) selectedOperators.delete(sourceOperator);
    if (targetOperator) selectedOperators.delete(targetOperator);

    // Swap the values
    sourceSelect.value = targetValue;
    targetSelect.value = sourceValue;

    // Update the dataset to track the selected operators
    sourceSelect.dataset.selectedOperator = targetValue;
    targetSelect.dataset.selectedOperator = sourceValue;

    // Add both operators back to the selected set if they have values
    if (targetValue) selectedOperators.add(targetValue);
    if (sourceValue) selectedOperators.add(sourceValue);

    // Update the UI
    updateOperatorDropdowns();
}

function updateWeekDatesDisplay() {
    const year = parseInt(document.getElementById('yearInput').value);
    const week = parseInt(document.getElementById('weekInput').value);
    
    const jan4 = new Date(year, 0, 4);
    const mondayWeek1 = new Date(jan4);
    mondayWeek1.setDate(jan4.getDate() - (jan4.getDay() || 7) + 1);
    
    const targetMonday = new Date(mondayWeek1);
    targetMonday.setDate(mondayWeek1.getDate() + (week - 1) * 7);
    
    const targetSunday = new Date(targetMonday);
    targetSunday.setDate(targetMonday.getDate() + 6);
    
    const formatDate = (date) => {
        return date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
    };
    
    const dateDisplay = `${formatDate(targetMonday)} - ${formatDate(targetSunday)}`;
    const weekDatesElement = document.getElementById('weekDatesDisplay');
    if (weekDatesElement) {
        weekDatesElement.textContent = dateDisplay;
    }
}

function updateYearFromInput(value) {
    const year = parseInt(value);
    const weekElement = document.getElementById('weekInput');
    const week = parseInt(weekElement.value);
    
    if (isNaN(year) || year < 1900 || year > 2100) {
        alert('Veuillez entrer une année valide entre 1900 et 2100');
        document.getElementById('yearInput').value = {{ year }};
        return;
    }
    
    const lastWeek = getLastWeekOfYear(year);
    if (week > lastWeek) {
        weekElement.value = lastWeek;
    }
    
    updateNavigation(year, parseInt(weekElement.value));
}

function updateWeekFromInput(value) {
    const week = parseInt(value);
    const yearElement = document.getElementById('yearInput');
    const year = parseInt(yearElement.value);
    
    if (isNaN(week) || week < 1 || week > 53) {
        alert('Veuillez entrer un numéro de semaine valide entre 1 et 53');
        document.getElementById('weekInput').value = {{ week }};
        return;
    }
    
    const lastWeek = getLastWeekOfYear(year);
    if (week > lastWeek) {
        alert(`La semaine ${week} n'est pas valide pour l'année ${year}. La dernière semaine de ${year} est ${lastWeek}`);
        document.getElementById('weekInput').value = lastWeek;
        return;
    }
    
    updateNavigation(year, week);
}

function changeYear(delta) {
    const yearElement = document.getElementById('yearInput');
    const weekElement = document.getElementById('weekInput');
    let year = parseInt(yearElement.value);
    let week = parseInt(weekElement.value);
    
    year += delta;
    
    const lastWeek = getLastWeekOfYear(year);
    if (week > lastWeek) {
        week = lastWeek;
        weekElement.value = week;
    }
    
    yearElement.value = year;
    updateNavigation(year, parseInt(weekElement.value));
}

function changeWeek(delta) {
    const yearElement = document.getElementById('yearInput');
    const weekElement = document.getElementById('weekInput');
    let year = parseInt(yearElement.value);
    let week = parseInt(weekElement.value);
    
    week += delta;
    const lastWeek = getLastWeekOfYear(year);
    
    if (week > lastWeek) {
        year++;
        week = 1;
    } else if (week < 1) {
        year--;
        week = getLastWeekOfYear(year);
    }
    
    yearElement.value = year;
    weekElement.value = week;
    updateNavigation(year, week);
}

function updateNavigation(year, week) {
    if (!isValidWeek(week, year)) {
        console.error('Invalid week calculation', { week, year });
        return;
    }
    
    updateWeekDatesDisplay();
    
    const currentUrl = new URL(window.location.href);
    currentUrl.searchParams.set('year', year);
    currentUrl.searchParams.set('week', week);
    window.location.href = currentUrl.toString();
}

// Add keyboard navigation
document.addEventListener('keydown', function(event) {
    if (event.altKey) {
        switch(event.key) {
            case 'ArrowLeft':
                changeWeek(-1);
                break;
            case 'ArrowRight':
                changeWeek(1);
                break;
            case 'ArrowUp':
                changeYear(1);
                break;
            case 'ArrowDown':
                changeYear(-1);
                break;
        }
    }
});

function goToCurrentWeek() {
    const current = getCurrentWeekYear();
    document.getElementById('yearInput').value = current.year;
    document.getElementById('weekInput').value = current.week;
    updateNavigation(current.year, current.week);
}

function goToNextWeek() {
    const yearElement = document.getElementById('yearInput');
    const weekElement = document.getElementById('weekInput');
    let year = parseInt(yearElement.value);
    let week = parseInt(weekElement.value);
    
    week++;
    const lastWeek = getLastWeekOfYear(year);
    
    if (week > lastWeek) {
        year++;
        week = 1;
    }
    
    yearElement.value = year;
    weekElement.value = week;
    updateNavigation(year, week);
}

function goToPreviousWeek() {
    const yearElement = document.getElementById('yearInput');
    const weekElement = document.getElementById('weekInput');
    let year = parseInt(yearElement.value);
    let week = parseInt(weekElement.value);
    
    week--;
    if (week < 1) {
        year--;
        week = getLastWeekOfYear(year);
    }
    
    yearElement.value = year;
    weekElement.value = week;
    updateNavigation(year, week);
}

function deselectOperator(event, element) {
    event.stopPropagation();
    const operatorItem = element.closest('.operator-item');
    const operatorsList = operatorItem.parentElement;
    const select = operatorItem.querySelector('.operator-select');

    // Remove the operator from selectedOperators set
    if (select.value) {
        selectedOperators.delete(select.value);
    }

    // If this is not the last item, remove it
    if (operatorItem !== operatorsList.lastElementChild) {
        operatorItem.remove();
        // Update positions for remaining operators
        Array.from(operatorsList.children).forEach((item, index) => {
            const itemSelect = item.querySelector('.operator-select');
            itemSelect.dataset.position = index + 1;
        });
    } else {
        // If it's the last item, just clear the selection
        select.value = '';
        delete select.dataset.selectedOperator;
    }

    // Show the add button on the new last item
    const lastItem = operatorsList.lastElementChild;
    if (lastItem) {
        const addButton = lastItem.querySelector('.add-operator-btn');
        if (addButton) {
            addButton.style.display = '';
        }
    }

    updateOperatorDropdowns();
}

// Prevent select from opening when clicking the x
const schedule = document.querySelector('.assignments-table');
schedule && schedule.addEventListener('mousedown', function(e) {
    if (e.target.classList.contains('deselect-operator')) {
        e.preventDefault();
    }
}, true);

function addOperator(button) {
    const cell = button.closest('.schedule-cell');
    const operatorsList = cell.querySelector('.operators-list');
    const machineId = cell.dataset.machineId;
    const productionId = cell.dataset.productionId;
    const shiftId = cell.dataset.shiftId;
    const position = operatorsList.children.length + 1;

    // Create a new operator-item with all available operators (but default selected)
    const operatorItem = document.createElement('div');
    operatorItem.className = 'operator-item';
    // Find a reference select to copy all options
    const referenceSelect = document.querySelector('.operator-select');
    let optionsHtml = '';
    if (referenceSelect) {
        optionsHtml = Array.from(referenceSelect.options)
            .map(opt => opt.outerHTML)
            .join('');
    } else {
        optionsHtml = '<option value="">Sélectionner un opérateur</option>';
    }
    operatorItem.innerHTML = `
        <div class="select-wrapper">
            <select class="operator-select" 
                    data-machine-id="${machineId}"
                    data-production-id="${productionId}"
                    data-shift-id="${shiftId}"
                    data-position="${position}"
                    onchange="handleOperatorSelection(this)">
                ${optionsHtml}
            </select>
            <span class="deselect-operator" onclick="deselectOperator(event, this)">×</span>
        </div>
    `;
    // Set default selection to empty
    operatorItem.querySelector('select').value = '';
    operatorsList.appendChild(operatorItem);
    updateOperatorDropdowns();
}
</script>
{% endblock %}
